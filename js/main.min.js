$(function(){let e=["../PianoNotationConversionTool/image/music.png","../PianoNotationConversionTool/image/lg.rainy-preloader.gif","../PianoNotationConversionTool/image/Pulse-1s-200px.gif"];for(let i=0;i<e.length;i++)n=e[i],(new Image).src=n;var n;setTimeout(function(){$(".loading").fadeOut()},1e3);let i=$(".piano"),a=$(".slide"),s=$(".text"),t=s.find(".number-panel"),o=s.find(".tabs-panel"),d=$(".toolbox"),c=$("#toolbox-btn"),l=$(".intro-wrap"),f=$(".intro-wrap .ctr-btn"),p=0,h=$(".note.selected"),r=$(".line.selected");function b(){h=$(".note.selected"),r=$(".line.selected")}function u(e,n,i,a){C(e);let s=e.find(".line.selected"),t=e.find(".note.selected");e.find(".note").removeClass("selected");let o=`<div class="note selected ${i}" style="background-color: ${a};">${n}</div>`;0!=t.length?t.after(o):s.append(o),function(e,n){n.on("click",function(i){e.find(".line").removeClass("selected"),e.find(".note").removeClass("selected"),n.addClass("selected"),n.parent(".line").addClass("selected"),b()})}(e,$(".note.selected")),b()}function m(e){C(e);let n=e.find(".note.selected"),i=n.prev(".note"),a=n.next(".note");0!=i.length?i.addClass("selected"):0!=a.length&&a.addClass("selected"),n.remove(),b()}function v(e,n){0==n.find(".note.selected").length&&(e.find(".line").removeClass("selected"),e.find(".note").removeClass("selected"),n.addClass("selected"),n.find(".note").last().addClass("selected"),b())}function g(e,n){if(e.find(".line").length>1){if(0!=n.find(".selected").length){let i=n.prev(".line"),a=n.next(".line");e.find(".line").removeClass("selected"),e.find(".note").removeClass("selected"),0!=i.length?(i.find(".note").last().addClass("selected"),i.addClass("selected")):0!=a.length&&(a.find(".note").last().addClass("selected"),a.addClass("selected"))}n.remove()}else e.find(".line").removeClass("selected"),e.find(".note").removeClass("selected"),n.children().not(".del").not(".line-bg").remove(),n.addClass("selected");b()}function y(e){let n="<div class='line selected' title='雙擊修改區塊顏色'><div class=\"del\">X</div></div>";e==o&&(n="\n                <div class='line selected' title='雙擊修改區塊顏色'>\n                    <div class='line-bg'><span></span><span></span><span></span><span></span><span></span></div>\n                    <div class=\"del\">X</div>\n                </div>");let i=e.find(".line.selected");e.find(".line.selected").removeClass("selected"),0!=i.length?i.after(n):e.append(n),e.find(".note.selected").removeClass("selected");let a=e.find(".line.selected");a.on("dblclick",function(e){!function(e){$(".colorarea").show();var n=e.css("border-left-color"),i=parseInt(B(n).red),a=parseInt(B(n).green),s=parseInt(B(n).blue),t=x(i,a,s);$(".colorbtn").removeClass("selected"),$(".colorbtn").each(function(e){var n=$(this).css("backgroundColor"),i=parseInt(B(n).red),a=parseInt(B(n).green),s=parseInt(B(n).blue);btn_hexString=x(i,a,s),t==btn_hexString&&$(this).addClass("selected")});var o=t;$(".colorbtn").on("click",function(){var e=$(this).css("backgroundColor"),n=parseInt(B(e).red),i=parseInt(B(e).green),a=parseInt(B(e).blue);o=x(n,i,a),$(".colorbtn").removeClass("selected"),$(this).addClass("selected")}),$(".colorbox").find(".checkbtn").remove(),$(".colorbox").append('<div class="checkbtn">確定</div>'),$(".checkbtn").on("click",function(){e.css("border-left-color",o),$(".colorarea").hide(),$(this).remove()})}($(this))}),a.on("click",function(n){let i=a.index();v(e.siblings(".panel"),e.siblings(".panel").find(".line").eq(i)),v(e,a)}),a.find(".del").on("click",function(n){let i=a.index();g(e.siblings(".panel"),e.siblings(".panel").find(".line").eq(i)),g(e,a)}),C(e),b()}function k(e,n){switch(e){case"line":switch(n){case"up":let e=r.prev(".line");0!=e.length&&($(".line").removeClass("selected"),e.addClass("selected"),$(".note").removeClass("selected"),t.find(".line.selected .note").last().addClass("selected"),o.find(".line.selected .note").last().addClass("selected"));break;case"down":let i=r.next(".line");0!=i.length&&($(".line").removeClass("selected"),i.addClass("selected"),$(".note").removeClass("selected"),t.find(".line.selected .note").last().addClass("selected"),o.find(".line.selected .note").last().addClass("selected"))}break;case"note":switch(n){case"left":let e=h.prev(".note");0!=e.length&&($(".note").removeClass("selected"),e.addClass("selected"));break;case"right":let i=h.next(".note");0!=i.length&&($(".note").removeClass("selected"),i.addClass("selected"))}}b()}function P(e){notekey=document.getElementById(e),notekey.pause(),notekey.currentTime=0,notekey.play()}function C(e){text_height=e.find(".line").height()*e.find(".line").length,s.animate({scrollTop:text_height},0)}function A(){p=i.scrollLeft()}function _(e){switch(e){case"close":s.stop().animate({height:"100%"},300),d.stop().animate({height:"100%"},300),i.stop().animate({bottom:"-35%"},300),a.hide(),A(),$(".toolbutton").eq(3).css("display","block"),$(".toolbutton").eq(4).css("display","none");break;case"open":s.stop().animate({height:"65%"},300),d.stop().animate({height:"65%"},300),i.stop().animate({bottom:"0"},300),a.show(),i.animate({scrollLeft:p},0),$(".toolbutton").eq(3).css("display","none"),$(".toolbutton").eq(4).css("display","block")}}function B(e){var n=e.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);return n?{red:n[1],green:n[2],blue:n[3]}:{}}function D(e){var n=e.toString(16);return 1==n.length?"0"+n:n}function x(e,n,i){return"#"+D(e)+D(n)+D(i)}$(".toolbutton").eq(3).css("display","none"),i.animate({scrollLeft:"2000vw"},500),A(),function(){let e=["#828282","#AD766A","#D5404A","#FFB11B","#90B44B","#58B2DC","#005CAF","#A8497A","#E87A90"],n=["A0","B0","C1","D1","E1","F1","G1","A1","B1","C2","D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6","F6","G6","A6","B6","C7","D7","E7","F7","G7","A7","B7","C8"],a=["Bb0","Db1","Eb1","Gb1","Ab1","Bb1","Db2","Eb2","Gb2","Ab2","Bb2","Db3","Eb3","Gb3","Ab3","Bb3","Db4","Eb4","Gb4","Ab4","Bb4","Db5","Eb5","Gb5","Ab5","Bb5","Db6","Eb6","Gb6","Ab6","Bb6","Db7","Eb7","Gb7","Ab7","Bb7"],s=["Ah0","Ch1","Dh1","Fh1","Gh1","Ah1","Ch2","Dh2","Fh2","Gh2","Ah2","Ch3","Dh3","Fh3","Gh3","Ah3","Ch4","Dh4","Fh4","Gh4","Ah4","Ch5","Dh5","Fh5","Gh5","Ah5","Ch6","Dh6","Fh6","Gh6","Ah6","Ch7","Dh7","Fh7","Gh7","Ah7"],t=["Piano.ff.A0.mp3","Piano.ff.B0.mp3","Piano.ff.C1.mp3","Piano.ff.D1.mp3","Piano.ff.E1.mp3","Piano.ff.F1.mp3","Piano.ff.G1.mp3","Piano.ff.A1.mp3","Piano.ff.B1.mp3","Piano.ff.C2.mp3","Piano.ff.D2.mp3","Piano.ff.E2.mp3","Piano.ff.F2.mp3","Piano.ff.G2.mp3","Piano.ff.A2.mp3","Piano.ff.B2.mp3","Piano.ff.C3.mp3","Piano.ff.D3.mp3","Piano.ff.E3.mp3","Piano.ff.F3.mp3","Piano.ff.G3.mp3","Piano.ff.A3.mp3","Piano.ff.B3.mp3","Piano.ff.C4.mp3","Piano.ff.D4.mp3","Piano.ff.E4.mp3","Piano.ff.F4.mp3","Piano.ff.G4.mp3","Piano.ff.A4.mp3","Piano.ff.B4.mp3","Piano.ff.C5.mp3","Piano.ff.D5.mp3","Piano.ff.E5.mp3","Piano.ff.F5.mp3","Piano.ff.G5.mp3","Piano.ff.A5.mp3","Piano.ff.B5.mp3","Piano.ff.C6.mp3","Piano.ff.D6.mp3","Piano.ff.E6.mp3","Piano.ff.F6.mp3","Piano.ff.G6.mp3","Piano.ff.A6.mp3","Piano.ff.B6.mp3","Piano.ff.C7.mp3","Piano.ff.D7.mp3","Piano.ff.E7.mp3","Piano.ff.F7.mp3","Piano.ff.G7.mp3","Piano.ff.A7.mp3","Piano.ff.B7.mp3","Piano.ff.C8.mp3"],o=["Piano.ff.Bb0.mp3","Piano.ff.Db1.mp3","Piano.ff.Eb1.mp3","Piano.ff.Gb1.mp3","Piano.ff.Ab1.mp3","Piano.ff.Bb1.mp3","Piano.ff.Db2.mp3","Piano.ff.Eb2.mp3","Piano.ff.Gb2.mp3","Piano.ff.Ab2.mp3","Piano.ff.Bb2.mp3","Piano.ff.Db3.mp3","Piano.ff.Eb3.mp3","Piano.ff.Gb3.mp3","Piano.ff.Ab3.mp3","Piano.ff.Bb3.mp3","Piano.ff.Db4.mp3","Piano.ff.Eb4.mp3","Piano.ff.Gb4.mp3","Piano.ff.Ab4.mp3","Piano.ff.Bb4.mp3","Piano.ff.Db5.mp3","Piano.ff.Eb5.mp3","Piano.ff.Gb5.mp3","Piano.ff.Ab5.mp3","Piano.ff.Bb5.mp3","Piano.ff.Db6.mp3","Piano.ff.Eb6.mp3","Piano.ff.Gb6.mp3","Piano.ff.Ab6.mp3","Piano.ff.Bb6.mp3","Piano.ff.Db7.mp3","Piano.ff.Eb7.mp3","Piano.ff.Gb7.mp3","Piano.ff.Ab7.mp3","Piano.ff.Bb7.mp3"],d=['<div class="ivory do"><span>1</span></div>','<div class="ivory re"><span>2</span></div>','<div class="ivory mi"><span>3</span></div>','<div class="ivory fa"><span>4</span></div>','<div class="ivory sol"><span>5</span></div>','<div class="ivory la"><span>6</span></div>','<div class="ivory si"><span>7</span></div>'],c=['<div class="ebony-wrap ebony_0"></div>','<div class="ebony-wrap ebony_1"></div>','<div class="ebony-wrap ebony_2"></div>','<div class="ebony-wrap ebony_3"></div>','<div class="ebony-wrap ebony_4"></div>','<div class="ebony-wrap ebony_5"></div>'],l=['<div class="ebony_child bre"><span>b2</span></div>','<div class="ebony_child bmi"><span>b3</span></div>','<div class="ebony_child bsol"><span>b5</span></div>','<div class="ebony_child bla"><span>b6</span></div>','<div class="ebony_child bsi"><span>b7</span></div>'],f=['<div class="ebony_child udo"><span>#1</span></div>','<div class="ebony_child ure"><span>#2</span></div>','<div class="ebony_child ufa"><span>#4</span></div>','<div class="ebony_child usol"><span>#5</span></div>','<div class="ebony_child ula"><span>#6</span></div>'];i.append('<div class="group_left"></div>');let p=$(".group_left");p.append(d[5]),p.append(d[6]),p.find("span").css({background:e[0]}),p.append(c[0]);let h=p.find(".ebony_0");h.append(f[4]),h.append(l[4]),p.find(".ebony_child").find("span").css({background:e[0]}),p.find(".ivory").each(function(e){$(this).append(`<div class="key">${n[e]}</div>`),$(this).append(`<audio id="${n[e]}"><source src="./audio/${t[e]}" type="audio/mpeg"></audio>`)}),p.find(".ebony_0").each(function(e){h.find(".ebony_child").each(function(n){n<1?$(this).append(`<div data-name="${s[e]}" class="key">${a[e]}</div>`):$(this).append(`<div data-name="${a[e]}" class="key">${a[e]}</div>`),$(this).append(`<audio id="${a[e]}"><source src="./audio/${o[e]}" type="audio/mpeg"></audio>`)})});for(var r=0;r<7;r++)i.append('<div class="group"></div>');$(".group").each(function(i){$(this).css({left:14.28+50*i+"%"});for(let e=0;e<=d.length;e++)$(this).append(d[e]);$(this).find("span").css({background:e[i+1]});for(let e=1;e<=c.length;e++)$(this).append(c[e]);for(let e=0;e<5;e++){let n=$(this).find(`.ebony_${e+1}`);n.append(f[e]),n.append(l[e])}$(this).find(".ebony_child").find("span").css({background:e[i+1]}),$(this).find(".ivory").each(function(e){$(this).append(`<div class="key">${n[2+7*i+e]}</div>`),$(this).append(`<audio id="${n[2+7*i+e]}"><source src="./audio/${t[2+7*i+e]}" type="audio/mpeg"></audio>`)}),$(this).find(".ebony_1").each(function(e){$(this).find(".ebony_child").each(function(e){e<1?$(this).append(`<div data-name="${s[1+5*i+0]}" class="key">${a[1+5*i+0]}</div>`):$(this).append(`<div data-name="${a[1+5*i+0]}" class="key">${a[1+5*i+0]}</div>`),$(this).append(`<audio id="${a[1+5*i+0]}"><source src="./audio/${o[1+5*i+0]}" type="audio/mpeg"></audio>`)})}),$(this).find(".ebony_2").each(function(e){$(this).find(".ebony_child").each(function(e){e<1?$(this).append(`<div data-name="${s[1+5*i+1]}" class="key">${a[1+5*i+1]}</div>`):$(this).append(`<div data-name="${a[1+5*i+1]}" class="key">${a[1+5*i+1]}</div>`),$(this).append(`<audio id="${a[1+5*i+1]}"><source src="./audio/${o[1+5*i+1]}" type="audio/mpeg"></audio>`)})}),$(this).find(".ebony_3").each(function(e){$(this).find(".ebony_child").each(function(e){e<1?$(this).append(`<div data-name="${s[1+5*i+2]}" class="key">${a[1+5*i+2]}</div>`):$(this).append(`<div data-name="${a[1+5*i+2]}" class="key">${a[1+5*i+2]}</div>`),$(this).append(`<audio id="${a[1+5*i+2]}"><source src="./audio/${o[1+5*i+2]}" type="audio/mpeg"></audio>`)})}),$(this).find(".ebony_4").each(function(e){$(this).find(".ebony_child").each(function(e){e<1?$(this).append(`<div data-name="${s[1+5*i+3]}" class="key">${a[1+5*i+3]}</div>`):$(this).append(`<div data-name="${a[1+5*i+3]}" class="key">${a[1+5*i+3]}</div>`),$(this).append('<audio id="'+a[1+5*i+3]+'"><source src="./audio/'+o[1+5*i+3]+'" type="audio/mpeg"></audio>')})}),$(this).find(".ebony_5").each(function(e){$(this).find(".ebony_child").each(function(e){e<1?$(this).append(`<div data-name="${s[1+5*i+4]}" class="key">${a[1+5*i+4]}</div>`):$(this).append(`<div data-name="${a[1+5*i+4]}" class="key">${a[1+5*i+4]}</div>`),$(this).append(`<audio id="${a[1+5*i+4]}"><source src="./audio/${o[1+5*i+4]}" type="audio/mpeg"></audio>`)})})}),i.append('<div class="group_right"></div>');let b=$(".group_right");b.append(d[0]),b.find("span").css({background:e[8]}),b.find(".ivory").each(function(){$(this).append(`<div class="key">${n[n.length-1]}</div>`),$(this).append(`<audio id="${n[n.length-1]}"><source src="./audio/${t[t.length-1]}" type="audio/mpeg"></audio>`)})}(),y(t),y(o),$(".title").on("dblclick",function(e){var n=function(e){var n=document.createElement("div");n.innerHTML=e;var i=n.innerText||n.textContent;return n=null,i}($(".title").html()),i=prompt("請輸入歌名：",n);null==i&&(i=n),$(".title").text(i)}),c.on("click",function(e){d.toggleClass("closed"),s.toggleClass("full")}),$(".cancelbtn").on("click",function(e){$(".colorarea").hide()}),f.on("click",function(e){l.removeClass("active"),$(".toolbutton").eq(6).removeClass("selected")}),isMobile.phone?($(".ivory").each(function(e){$(this).on("touchstart",function(e){$(this).css({background:"#f2f2f2"}),u(t,$(this).find("span").text(),$(this).find(".key").text(),$(this).find("span").css("background-color")),u(o,$(this).find("span").text(),$(this).find(".key").text(),$(this).find("span").css("background-color")),P($(this).find(".key").text())}).on("touchend",function(e){$(this).css({background:"#fff"})})}),$(".ebony_0").each(function(e){$(".ebony_child").each(function(e){$(this).on("touchstart",function(e){$(this).css({background:"#444"}),u(t,$(this).find("span").text(),$(this).find(".key").attr("data-name"),$(this).find("span").css("background-color")),u(o,$(this).find("span").text(),$(this).find(".key").attr("data-name"),$(this).find("span").css("background-color")),P($(this).find(".key").text())}).on("touchend",function(e){$(this).css({background:"#000"})})})}),$(".toolbutton").each(function(e){$(this).on("touchstart",function(n){switch($(this).addClass("selected"),e){case 0:m(t),m(o);break;case 1:u(t,"0","whitespace","rgba(255, 255, 255, 0.2)"),u(o,"0","whitespace","rgba(255, 255, 255, 0.2)");break;case 2:y(t),y(o);break;case 3:_("open");break;case 4:_("close");break;case 5:t.toggleClass("open"),o.toggleClass("open");break;case 6:l.addClass("active")}}).on("touchend",function(e){$(this).removeClass("selected")})})):($(".ivory").each(function(e){$(this).on("mousedown",function(e){$(this).css({background:"#f2f2f2"}),u(t,$(this).find("span").text(),$(this).find(".key").text(),$(this).find("span").css("background-color")),u(o,$(this).find("span").text(),$(this).find(".key").text(),$(this).find("span").css("background-color")),P($(this).find(".key").text())}).on("mouseup",function(e){$(this).css({background:"#fff"})})}),$(".ebony_0").each(function(e){$(".ebony_child").each(function(e){$(this).on("mousedown",function(e){$(this).css({background:"#444"}),u(t,$(this).find("span").text(),$(this).find(".key").attr("data-name"),$(this).find("span").css("background-color")),u(o,$(this).find("span").text(),$(this).find(".key").attr("data-name"),$(this).find("span").css("background-color")),P($(this).find(".key").text())}).on("mouseup",function(e){$(this).css({background:"#000"})})})}),$(".toolbutton").each(function(e){$(this).on("mousedown",function(n){switch($(this).addClass("selected"),e){case 0:m(t),m(o);break;case 1:u(t,"0","whitespace","rgba(255, 255, 255, 0.2)"),u(o,"0","whitespace","rgba(255, 255, 255, 0)");break;case 2:y(t),y(o);break;case 3:_("open");break;case 4:_("close");break;case 5:t.toggleClass("open"),o.toggleClass("open");break;case 6:l.addClass("active")}}).on("mouseup",function(e){$(this).removeClass("selected")})}),$(window).on("keydown",function(e){switch(e.keyCode){case 8:m(t),m(o);break;case 13:y(t),y(o);break;case 32:u(t,"0","0","rgba(255, 255, 255, 0.2)"),u(o,"0","0","rgba(255, 255, 255, 0)");break;case 65:k("note","left");break;case 87:k("line","up");break;case 68:k("note","right");break;case 83:k("line","down")}}))});