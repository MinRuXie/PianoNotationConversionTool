$(function(){setTimeout(function(){$(".loading").fadeOut()},1e3);let e=$(".piano"),n=$(".slide"),s=$(".text"),t=s.find(".number-panel"),i=s.find(".tabs-panel"),a=$(".toolbox"),o=$("#toolbox-btn"),d=$(".colorarea"),c=$(".colorbox"),l=$(".intro-wrap"),r=$(".intro-wrap .ctr-btn"),h=0,p=$(".note.selected"),f=$(".line.selected");function b(){p=$(".note.selected"),f=$(".line.selected")}function u(e,n,s,t){x(e);let i=e.find(".line.selected"),a=e.find(".note.selected");e.find(".note").removeClass("selected");let o=`<div title="${s.replace(/h/,"#")}" class="note selected ${s}" style="background-color: ${t};">${n}</div>`;0!=a.length?a.after(o):i.append(o),function(e,n){n.on("click",function(s){e.find(".line").removeClass("selected"),e.find(".note").removeClass("selected"),n.addClass("selected"),n.parent(".line").addClass("selected"),b()})}(e,$(".note.selected")),b()}function v(e){x(e);let n=e.find(".note.selected"),s=n.prev(".note"),t=n.next(".note");0!=s.length?s.addClass("selected"):0!=t.length&&t.addClass("selected"),n.remove(),b()}function g(e,n){0==n.find(".note.selected").length&&(e.find(".line").removeClass("selected"),e.find(".note").removeClass("selected"),n.addClass("selected"),n.find(".note").last().addClass("selected"),b())}function k(e,n){if(e.find(".line").length>1){if(0!=n.find(".selected").length){let s=n.prev(".line"),t=n.next(".line");e.find(".line").removeClass("selected"),e.find(".note").removeClass("selected"),0!=s.length?(s.find(".note").last().addClass("selected"),s.addClass("selected")):0!=t.length&&(t.find(".note").last().addClass("selected"),t.addClass("selected"))}n.remove()}else e.find(".line").removeClass("selected"),e.find(".note").removeClass("selected"),n.children().not(".del").not(".line-bg").remove(),n.addClass("selected");b()}function m(e){let n="<div class='line selected' title='雙擊修改區塊顏色'><div class=\"del\">X</div></div>";e==i&&(n="\n                <div class='line selected' title='雙擊修改區塊顏色'>\n                    <div class='line-bg'><span></span><span></span><span></span><span></span><span></span></div>\n                    <div class=\"del\">X</div>\n                </div>");let s=e.find(".line.selected");e.find(".line.selected").removeClass("selected"),0!=s.length?s.after(n):e.append(n),e.find(".note.selected").removeClass("selected");let t=e.find(".line.selected");t.on("dblclick",function(n){!function(e,n){d.show();var s=n.css("border-left-color"),t=parseInt(_(s).red),i=parseInt(_(s).green),a=parseInt(_(s).blue),o=B(t,i,a);$(".colorbtn").removeClass("selected"),$(".colorbtn").each(function(e){var n=$(this).css("backgroundColor"),s=parseInt(_(n).red),t=parseInt(_(n).green),i=parseInt(_(n).blue);btn_hexString=B(s,t,i),o==btn_hexString&&$(this).addClass("selected")});var l=o;$(".colorbtn").on("click",function(){var e=$(this).css("backgroundColor"),n=parseInt(_(e).red),s=parseInt(_(e).green),t=parseInt(_(e).blue);l=B(n,s,t),$(".colorbtn").removeClass("selected"),$(this).addClass("selected")}),c.find(".checkbtn").remove(),c.append('<div class="checkbtn">確定</div>'),$(".checkbtn").on("click",function(){n.css("border-left-color",l),d.hide(),$(this).remove();let s=n.index();e.siblings(".panel").find(".line").eq(s).css("border-left-color",l)})}(e,$(this))}),t.on("click",function(n){let s=t.index();g(e.siblings(".panel"),e.siblings(".panel").find(".line").eq(s)),g(e,t)}),t.find(".del").on("click",function(n){let s=t.index();k(e.siblings(".panel"),e.siblings(".panel").find(".line").eq(s)),k(e,t)}),x(e),b()}function C(e,n){switch(e){case"line":switch(n){case"up":let e=f.prev(".line");0!=e.length&&($(".line").removeClass("selected"),e.addClass("selected"));break;case"down":let s=f.next(".line");0!=s.length&&($(".line").removeClass("selected"),s.addClass("selected"))}$(".note").removeClass("selected"),t.find(".line.selected .note").last().addClass("selected"),i.find(".line.selected .note").last().addClass("selected");break;case"note":switch(n){case"left":let e=p.prev(".note");0!=e.length&&($(".note").removeClass("selected"),e.addClass("selected"));break;case"right":let s=p.next(".note");0!=s.length&&($(".note").removeClass("selected"),s.addClass("selected"))}}b()}function y(e){notekey=document.getElementById(e),notekey.pause(),notekey.currentTime=0,notekey.play()}function x(e){text_height=e.find(".line").height()*e.find(".line").length,s.animate({scrollTop:text_height},0)}function A(){h=e.scrollLeft()}function w(t){switch(t){case"close":s.stop().animate({height:"100%"},300),a.stop().animate({height:"100%"},300),e.stop().animate({bottom:"-35%"},300),n.hide(),A(),$(".toolbutton").eq(3).css("display","block"),$(".toolbutton").eq(4).css("display","none");break;case"open":s.stop().animate({height:"65%"},300),a.stop().animate({height:"65%"},300),e.stop().animate({bottom:"0"},300),n.show(),e.animate({scrollLeft:h},0),$(".toolbutton").eq(3).css("display","none"),$(".toolbutton").eq(4).css("display","block")}}function _(e){var n=e.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);return n?{red:n[1],green:n[2],blue:n[3]}:{}}function D(e){var n=e.toString(16);return 1==n.length?"0"+n:n}function B(e,n,s){return"#"+D(e)+D(n)+D(s)}$(".toolbutton").eq(3).css("display","none"),e.animate({scrollLeft:"2000vw"},500),A(),function(){let n=["#828282","#AD766A","#D5404A","#FFB11B","#90B44B","#58B2DC","#005CAF","#A8497A","#E87A90"],s=["A0","B0","C1","D1","E1","F1","G1","A1","B1","C2","D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6","F6","G6","A6","B6","C7","D7","E7","F7","G7","A7","B7","C8"],t=["Bb0","Db1","Eb1","Gb1","Ab1","Bb1","Db2","Eb2","Gb2","Ab2","Bb2","Db3","Eb3","Gb3","Ab3","Bb3","Db4","Eb4","Gb4","Ab4","Bb4","Db5","Eb5","Gb5","Ab5","Bb5","Db6","Eb6","Gb6","Ab6","Bb6","Db7","Eb7","Gb7","Ab7","Bb7"],i=["Ah0","Ch1","Dh1","Fh1","Gh1","Ah1","Ch2","Dh2","Fh2","Gh2","Ah2","Ch3","Dh3","Fh3","Gh3","Ah3","Ch4","Dh4","Fh4","Gh4","Ah4","Ch5","Dh5","Fh5","Gh5","Ah5","Ch6","Dh6","Fh6","Gh6","Ah6","Ch7","Dh7","Fh7","Gh7","Ah7"],a=["1","2","3","4","5","6","7"],o=["b2","b3","b5","b6","b7"],d=["#1","#2","#4","#5","#6"];e.append('<div class="group_left"></div>');let c=$(".group_left");c.append(`<div class="ivory"><span>${a[5]}</span></div>`),c.append(`<div class="ivory"><span>${a[6]}</span></div>`),c.find("span").css({background:n[0]}),c.append('<div class="ebony-wrap ebony_0"></div>');let l=c.find(".ebony_0");l.append(`<div class="ebony_child"><span>${d[4]}</span></div>`),l.append(`<div class="ebony_child"><span>${o[4]}</span></div>`),c.find(".ebony_child").find("span").css({background:n[0]}),c.find(".ivory").each(function(e){$(this).append(`<div class="key">${s[e]}</div>`),$(this).append(`<audio id="${s[e]}"><source src="./audio/Piano.ff.${s[e]}.mp3" type="audio/mpeg"></audio>`)}),c.find(".ebony_0").each(function(e){l.find(".ebony_child").each(function(n){n<1?$(this).append(`<div data-name="${i[e]}" class="key">${i[e]}</div>`):$(this).append(`<div data-name="${t[e]}" class="key">${t[e]}</div>`),$(this).append(`<audio id="${t[e]}"><source src="./audio/Piano.ff.${t[e]}.mp3" type="audio/mpeg"></audio>`)})});for(let n=0;n<7;n++)e.append('<div class="group"></div>');$(".group").each(function(e){$(this).css({left:14.28+50*e+"%"});for(let e=0;e<=6;e++)$(this).append(`<div class="ivory"><span>${a[e]}</span></div>`);$(this).find("span").css({background:n[e+1]});for(let e=1;e<=5;e++)$(this).append(`<div class="ebony-wrap ebony_${e}"></div>`);for(let e=0;e<5;e++){let n=$(this).find(`.ebony_${e+1}`);n.append(`<div class="ebony_child"><span>${d[e]}</span></div>`),n.append(`<div class="ebony_child"><span>${o[e]}</span></div>`)}$(this).find(".ebony_child").find("span").css({background:n[e+1]}),$(this).find(".ivory").each(function(n){$(this).append(`<div class="key">${s[2+7*e+n]}</div>`),$(this).append(`<audio id="${s[2+7*e+n]}"><source src="./audio/Piano.ff.${s[2+7*e+n]}.mp3" type="audio/mpeg"></audio>`)});for(let n=0;n<5;n++)$(this).find(`.ebony_${n+1}`).each(function(s){$(this).find(".ebony_child").each(function(s){s<1?$(this).append(`<div data-name="${i[1+5*e+n]}" class="key">${i[1+5*e+n]}</div>`):$(this).append(`<div data-name="${t[1+5*e+n]}" class="key">${t[1+5*e+n]}</div>`),$(this).append(`<audio id="${t[1+5*e+n]}"><source src="./audio/Piano.ff.${t[1+5*e+n]}.mp3" type="audio/mpeg"></audio>`)})})}),e.append('<div class="group_right"></div>');let r=$(".group_right");r.append(`<div class="ivory"><span>${a[0]}</span></div>`),r.find("span").css({background:n[8]}),r.find(".ivory").each(function(){$(this).append(`<div class="key">${s[s.length-1]}</div>`),$(this).append(`<audio id="${s[s.length-1]}"><source src="./audio/Piano.ff.${s[s.length-1]}.mp3" type="audio/mpeg"></audio>`)})}(),m(t),m(i),$(".title").on("dblclick",function(e){var n=function(e){var n=document.createElement("div");n.innerHTML=e;var s=n.innerText||n.textContent;return n=null,s}($(".title").html()),s=prompt("請輸入歌名：",n);null==s&&(s=n),$(".title").text(s)}),o.on("click",function(e){a.toggleClass("closed"),s.toggleClass("full")}),$(".cancelbtn").on("click",function(e){d.hide()}),r.on("click",function(e){l.removeClass("active"),$(".toolbutton").eq(6).removeClass("selected")}),isMobile.phone?($(".ivory").each(function(e){$(this).on("touchstart",function(e){$(this).css({background:"#f2f2f2"}),u(t,$(this).find("span").text(),$(this).find(".key").text(),$(this).find("span").css("background-color")),u(i,$(this).find("span").text(),$(this).find(".key").text(),$(this).find("span").css("background-color")),y($(this).find(".key").text())}).on("touchend",function(e){$(this).css({background:"#fff"})})}),$(".ebony_0").each(function(e){$(".ebony_child").each(function(e){$(this).on("touchstart",function(e){$(this).css({background:"#444"}),u(t,$(this).find("span").text(),$(this).find(".key").attr("data-name"),$(this).find("span").css("background-color")),u(i,$(this).find("span").text(),$(this).find(".key").attr("data-name"),$(this).find("span").css("background-color")),y($(this).find(".key").text())}).on("touchend",function(e){$(this).css({background:"#000"})})})}),$(".toolbutton").each(function(e){$(this).on("touchstart",function(n){switch($(this).addClass("selected"),e){case 0:v(t),v(i);break;case 1:u(t,"","whitespace","rgba(255, 255, 255, 0.2)"),u(i,"","whitespace","rgba(255, 255, 255, 0.2)");break;case 2:m(t),m(i);break;case 3:w("open");break;case 4:w("close");break;case 5:t.toggleClass("open"),i.toggleClass("open");break;case 6:l.addClass("active")}}).on("touchend",function(e){$(this).removeClass("selected")})})):($(".ivory").each(function(e){$(this).on("mousedown",function(e){$(this).css({background:"#f2f2f2"}),u(t,$(this).find("span").text(),$(this).find(".key").text(),$(this).find("span").css("background-color")),u(i,$(this).find("span").text(),$(this).find(".key").text(),$(this).find("span").css("background-color")),y($(this).find(".key").text())}).on("mouseup",function(e){$(this).css({background:"#fff"})})}),$(".ebony_0").each(function(e){$(".ebony_child").each(function(e){$(this).on("mousedown",function(e){$(this).css({background:"#444"}),u(t,$(this).find("span").text(),$(this).find(".key").attr("data-name"),$(this).find("span").css("background-color")),u(i,$(this).find("span").text(),$(this).find(".key").attr("data-name"),$(this).find("span").css("background-color")),y($(this).find(".key").text())}).on("mouseup",function(e){$(this).css({background:"#000"})})})}),$(".toolbutton").each(function(e){$(this).on("mousedown",function(n){switch($(this).addClass("selected"),e){case 0:v(t),v(i);break;case 1:u(t,"","whitespace","rgba(255, 255, 255, 0.2)"),u(i,"","whitespace","rgba(255, 255, 255, 0)");break;case 2:m(t),m(i);break;case 3:w("open");break;case 4:w("close");break;case 5:t.toggleClass("open"),i.toggleClass("open");break;case 6:l.addClass("active")}}).on("mouseup",function(e){$(this).removeClass("selected")})}),$(window).on("keydown",function(e){switch(e.keyCode){case 8:v(t),v(i);break;case 13:m(t),m(i);break;case 32:u(t,"","whitespace","rgba(255, 255, 255, 0.2)"),u(i,"","whitespace","rgba(255, 255, 255, 0)");break;case 65:C("note","left");break;case 87:C("line","up");break;case 68:C("note","right");break;case 83:C("line","down")}}))});